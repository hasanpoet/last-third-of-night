<!DOCTYPE html>
<html>
<head>
    <title>Last Third of the Night</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body { font-family: sans-serif; max-width: 600px; margin: auto; padding: 20px; }
        h1 { color: #2c3e50; }
        #output { margin-top: 20px; font-size: 1.2em; }
    </style>
</head>
<body>
    <h1>Calculate Last Third of the Night (Starting of Tahajjud Time)</h1>
    <button onclick="getPrayerTimes()">Get My Times</button>
    <div id="output"></div>

    <script>
        async function getPrayerTimes() {
            const output = document.getElementById("output");
            output.innerHTML = "Getting location...";

            if (!navigator.geolocation) {
                output.innerHTML = "Geolocation is not supported by your browser.";
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                output.innerHTML = "Fetching prayer times...";

                const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`);
                const data = await res.json();

                const timings = data.data.timings;
                const maghribStr = timings.Maghrib;
                const fajrStr = timings.Fajr;

                const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const geoData = await geoRes.json();
                const city = geoData.address.city || geoData.address.town || geoData.address.village;
                const country = geoData.address.country;
                const locationName = `${city}, ${country}`;


                // Convert to Date objects
                const now = new Date();
                const maghrib = new Date(now.toDateString() + ' ' + maghribStr);
                let fajr = new Date(now.toDateString() + ' ' + fajrStr);
                if (fajr <= maghrib) fajr.setDate(fajr.getDate() + 1);  // next day

                const durationMs = fajr - maghrib;
                const thirdMs = durationMs / 3;
                const lastThirdStart = new Date(fajr - thirdMs);

                output.innerHTML = `
                    <p><strong>My Location:</strong> ${locationName}</p>
                    <p><strong>Maghrib Starts:</strong> ${maghrib.toLocaleTimeString()}</p>
                    <p><strong>Fajr Starts:</strong> ${fajr.toLocaleTimeString()}</p>
                    <p><strong>Last Third (Tahajjud Time) Starts:</strong> ${lastThirdStart.toLocaleTimeString()}</p>
                `;
            }, () => {
                output.innerHTML = "Unable to get your location.";
            });
        }
    </script>
    <form action="https://www.paypal.com/donate" method="post" target="_top">
        <input type="hidden" name="business" value="FZX25N6JE86A2" />
        <input type="hidden" name="no_recurring" value="0" />
        <input type="hidden" name="item_name" value="Please buy me a coffee to help me continue this coffee time project to give you more useful information in future." />
        <input type="hidden" name="currency_code" value="CAD" />
        <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
        <img alt="" border="0" src="https://www.paypal.com/en_CA/i/scr/pixel.gif" width="1" height="1" />
    </form>

</body>
</html>
