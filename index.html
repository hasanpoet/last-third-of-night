<!DOCTYPE html>
<html>
<head>
    <!-- Block for Google Analytics: Start -->
      <!-- Google tag (gtag.js) -->
      <script async src="https://www.googletagmanager.com/gtag/js?id=G-7XH44SBB5G"></script>
      <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-7XH44SBB5G');
      </script>
    <!-- Block for Google Analytics: End -->

    <title>Last Third of the Night - Tahajjud Time</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
        body {
            font-family: sans-serif;
            max-width: 700px;
            margin: auto;
            padding: 20px;
            line-height: 1.6;
        }
        h1 {
            color: #2c3e50;
        }
        #output {
            margin-top: 20px;
            font-size: 1.2em;
        }
        .section {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #ccc;
        }
        .donate-text {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .center {
            text-align: center;
        }
        .flex-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 20px;
        }

        .box {
            flex: 1;
            min-width: 280px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        th, td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
    </style>
    
</head>

<body>
    <h1>Calculate Last Third of the Night (Starting of Tahajjud Time)</h1>
    <button onclick="getPrayerTimes()">Get My Times</button>
    <div id="output"></div>

    <div class="section center">
        <p class="donate-text">Please buy me a coffee to help me continue this coffee-time project and share more useful tools in the future.</p>
        <form action="https://www.paypal.com/donate" method="post" target="_top">
            <input type="hidden" name="business" value="FZX25N6JE86A2" />
            <input type="hidden" name="no_recurring" value="0" />
            <input type="hidden" name="item_name" value="Please buy me a coffee to help me continue this coffee time project to give you more useful information in future." />
            <input type="hidden" name="currency_code" value="CAD" />
            <input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donateCC_LG.gif"
                   border="0" name="submit" title="Donate with PayPal"
                   alt="Donate with PayPal button" />
            <img alt="" border="0" src="https://www.paypal.com/en_CA/i/scr/pixel.gif" width="1" height="1" />
        </form>
    </div>

    <script>
        function formatPrayerTimesToAMPM(timings) {
            const todayStr = new Date().toDateString();

            const format = (timeStr) =>
                new Date(todayStr + ' ' + timeStr).toLocaleTimeString([], {
                    hour: 'numeric',
                    minute: '2-digit'
                });

            return {
                Fajr: format(timings.Fajr),
                Dhuhr: format(timings.Dhuhr),
                Asr: format(timings.Asr),
                Maghrib: format(timings.Maghrib),
                Isha: format(timings.Isha)
            };
        }

        async function getPrayerTimes() {
            const output = document.getElementById("output");
            output.innerHTML = "Getting location...";

            if (!navigator.geolocation) {
                output.innerHTML = "Geolocation is not supported by your browser.";
                return;
            }

            navigator.geolocation.getCurrentPosition(async (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;

                output.innerHTML = "Fetching prayer times...";

                const res = await fetch(`https://api.aladhan.com/v1/timings?latitude=${lat}&longitude=${lon}&method=2`);
                const data = await res.json();

                const timings = data.data.timings;
                const maghribStr = timings.Maghrib;
                const fajrStr = timings.Fajr;

                const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`);
                const geoData = await geoRes.json();
                const city = geoData.address.city || geoData.address.town || geoData.address.village;
                const country = geoData.address.country;
                const locationName = `${city}, ${country}`;

                const now = new Date();
                const maghrib = new Date(now.toDateString() + ' ' + maghribStr);
                let fajr = new Date(now.toDateString() + ' ' + fajrStr);
                if (fajr <= maghrib) fajr.setDate(fajr.getDate() + 1);  // next day

                const durationMs = fajr - maghrib;
                const thirdMs = durationMs / 3;
                const lastThirdStart = new Date(fajr - thirdMs);

                const formattedTimes = formatPrayerTimesToAMPM(timings);

                output.innerHTML = `
                <p><strong>My Location:</strong> ${locationName}</p>
            
                <div class="flex-wrapper">
                    <div class="box">
                        <p><strong>Maghrib Starts:</strong> ${maghrib.toLocaleTimeString()}</p>
                        <p><strong>Fajr Starts:</strong> ${fajr.toLocaleTimeString()}</p>
                        <p><strong>Last Third (Tahajjud Time) Starts:</strong> ${lastThirdStart.toLocaleTimeString()}</p>
                    </div>
            
                    <div class="box">
                        <h3>ðŸ•‹ 5 Daily Prayer Times</h3>
                        <table>
                            <tr><th>Prayer</th><th>Time</th></tr>
                            <tr><td>Fajr</td><td>${formattedTimes.Fajr}</td></tr>
                            <tr><td>Dhuhr</td><td>${formattedTimes.Dhuhr}</td></tr>
                            <tr><td>Asr</td><td>${formattedTimes.Asr}</td></tr>
                            <tr><td>Maghrib</td><td>${formattedTimes.Maghrib}</td></tr>
                            <tr><td>Isha</td><td>${formattedTimes.Isha}</td></tr>
                        </table>
                    </div>
                </div>
            `;
            }, () => {
                output.innerHTML = "Unable to get your location.";
            });
        }
    </script>
</body>
</html>
